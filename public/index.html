<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home - Nhà Hoa Hậu</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --text-color: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0; padding: 20px;
            background: #0f172a url('https://images.unsplash.com/photo-1558002038-1055907df827?q=80&w=2070&auto=format&fit=crop') center/cover fixed;
            color: var(--text-color);
            min-height: 100vh;
        }

        body::before { content: ''; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: -1; }

        h1 { text-align: center; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; font-weight: 600; }

        /* --- THIẾT KẾ NÚT TỔNG --- */
        .master-wrapper {
            display: flex; flex-direction: column; align-items: center;
            margin: 0 auto 50px; padding: 25px; max-width: 220px;
            background: rgba(255, 255, 255, 0.05); border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);
        }

        .master-label { font-size: 0.8rem; font-weight: 600; letter-spacing: 2px; margin-bottom: 15px; color: var(--secondary-color); text-transform: uppercase; }

        .master-switch { position: relative; width: 100px; height: 50px; }
        .master-switch input { opacity: 0; width: 0; height: 0; }

        .m-slider {
            position: absolute; inset: 0; cursor: pointer; background: rgba(0,0,0,0.4);
            border-radius: 50px; transition: 0.4s; border: 2px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between; padding: 0 12px;
        }

        .m-slider:before {
            content: ""; position: absolute; height: 38px; width: 38px; left: 6px; bottom: 4px;
            background: #fff; border-radius: 50%; transition: 0.4s; z-index: 2; box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .master-switch input:checked + .m-slider { background: linear-gradient(45deg, #00f2fe, #4facfe); box-shadow: 0 0 25px rgba(0, 242, 254, 0.5); }
        .master-switch input:checked + .m-slider:before { transform: translateX(48px); }

        .m-slider i { font-size: 1.2rem; transition: 0.4s; z-index: 1; }
        .icon-on { color: transparent; }
        .icon-off { color: rgba(255,255,255,0.4); }
        input:checked + .m-slider .icon-on { color: #fff; }
        input:checked + .m-slider .icon-off { color: transparent; }

        /* --- LƯỚI THIẾT BỊ --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }

        .card {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
            padding: 20px; text-align: center; transition: 0.3s; position: relative;
        }

        .card.active { border-color: var(--secondary-color); background: rgba(0, 242, 254, 0.1); }
        .card.active i { color: #ffd700; text-shadow: 0 0 15px #ffd700; }
        .card.offline { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .card.offline::after { content: 'MẤT KẾT NỐI'; position: absolute; top: 10px; right: 10px; font-size: 0.6rem; background: #ff4b2b; padding: 2px 6px; border-radius: 5px; font-weight: 600; }

        .icon-container { font-size: 2.2rem; margin-bottom: 10px; color: rgba(255,255,255,0.3); }

        .switch { position: relative; width: 50px; height: 26px; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; inset: 0; background: rgba(255,255,255,0.2); border-radius: 34px; cursor: pointer; transition: 0.4s; }
        .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 4px; bottom: 4px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>

    <h1><i class="fas fa-home"></i> HỆ THỐNG ĐÈN NHÀ HOA HẬU</h1>

    <div class="master-wrapper">
        <span class="master-label">ĐIỀU KHIỂN TỔNG</span>
        <label class="master-switch">
            <input type="checkbox" id="master-trigger" onchange="masterControl(this)">
            <span class="m-slider">
                <i class="fas fa-power-off icon-off"></i>
                <i class="fas fa-lightbulb icon-on"></i>
            </span>
        </label>
    </div>

    <div class="grid" id="main-grid">
        <script>
            const lights = [
                {id: 'porch', name: 'HIÊN', node: 'node1', icon: 'umbrella-beach'},
                {id: 'living_room1', name: 'PHÒNG KHÁCH 1', node: 'node1', icon: 'couch'},
                {id: 'living_room2', name: 'PHÒNG KHÁCH 2', node: 'node2', icon: 'tv'},
                {id: 'indoor_street', name: 'ĐƯỜNG LUỒNG', node: 'node2', icon: 'road'},
                {id: 'room1', name: 'PHÒNG HOÀNG', node: 'node2', icon: 'user-tie'},
                {id: 'room2', name: 'PHÒNG HƯƠNG', node: 'node3', icon: 'user-graduate'},
                {id: 'room3', name: 'PHÒNG BA MẸ', node: 'node3', icon: 'user-friends'},
                {id: 'dining_room', name: 'PHÒNG ĂN', node: 'node3', icon: 'utensils'},
                {id: 'kitchen', name: 'BẾP', node: 'node4', icon: 'fire-burner'},
                {id: 'bath', name: 'NHÀ TẮM', node: 'node4', icon: 'bath'},
                {id: 'toilet', name: 'NHÀ VỆ SINH', node: 'node4', icon: 'restroom'},
                {id: 'washing_machine', name: 'MÁY GIẶT', node: 'node4', icon: 'soap'}
            ];

            document.getElementById('main-grid').innerHTML = lights.map(l => `
                <div class="card ${l.node}" id="${l.id}-card">
                    <div class="icon-container"><i class="fas fa-${l.icon}"></i></div>
                    <h3>${l.name}</h3>
                    <label class="switch">
                        <input type="checkbox" id="${l.id}" onchange="toggleLight(this, 'hoanghoahau/smartlight/${l.node}/${l.id}')">
                        <span class="slider"></span>
                    </label>
                </div>
            `).join('');
        </script>
    </div>

    <script>
        let socket;
        function connectWS() {
            socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`);
            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'node_connectivity') updateNodeStatus(data.node, data.status);
                else if (data.relay) updateUI(data.relay, data.state);
            };
            socket.onclose = () => setTimeout(connectWS, 3000);
        }

        function updateNodeStatus(node, status) {
            document.querySelectorAll(`.${node}`).forEach(c => {
                c.classList.toggle('offline', status === 'OFFLINE');
                const cb = c.querySelector('input');
                if (cb) cb.disabled = (status === 'OFFLINE');
            });
        }

        function updateUI(relay, state) {
            const id = relay.split('/').pop();
            const cb = document.getElementById(id);
            if (cb) {
                cb.checked = (state === 'ON');
                document.getElementById(id + '-card').classList.toggle('active', state === 'ON');
            }
        }

        // HÀM ĐIỀU KHIỂN TỔNG VỚI XÁC NHẬN
        async function masterControl(el) {
            const state = el.checked ? 'ON' : 'OFF';
            const hanhDong = el.checked ? 'BẬT TẤT CẢ' : 'TẮT TẤT CẢ';
            
            // Hiện bảng hỏi xác nhận
            const xacNhan = confirm(`Bạn có chắc chắn muốn ${hanhDong} các thiết bị không?`);
            
            if (xacNhan) {
                try {
                    await fetch('/control-all', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ state })
                    });
                } catch (err) {
                    alert("Lỗi kết nối Server!");
                    el.checked = !el.checked;
                }
            } else {
                // Nếu hủy thì trả trạng thái nút gạt về như cũ
                el.checked = !el.checked;
            }
        }

        async function toggleLight(el, relay) {
            try {
                await fetch('/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ relay, state: el.checked ? 'ON' : 'OFF' })
                });
            } catch (err) {
                alert("Lỗi điều khiển!");
                el.checked = !el.checked;
            }
        }

        connectWS();
    </script>
</body>
</html>
